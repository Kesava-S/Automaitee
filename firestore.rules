rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    function isOwner() {
      return hasRole('owner');
    }

    function isAdmin() {
      return hasRole('admin') || isOwner();
    }

    function isManager() {
      return hasRole('manager') || isAdmin();
    }

    function isEmployee() {
      return hasRole('employee') || isManager();
    }
    
    function isClient() {
      return hasRole('client');
    }

    function isSelf(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- Collection Rules ---

    // Users: Public read for auth users (for directory), write restricted
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isSelf(userId); // Initial profile creation
      allow update: if isAdmin(); // Admins can update anything
      allow update: if isSelf(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'salary']); // Users can update details but not sensitive fields
      allow delete: if isAdmin();
    }

    // Projects: Managers+ can write, involved users can read
    match /projects/{projectId} {
      allow read: if isAuthenticated(); // Refine: if resource.data.clientId == request.auth.uid || isEmployee()
      allow write: if isManager();
    }

    // Tasks: Managers create, Employees update status
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create, delete: if isManager();
      allow update: if isManager();
      allow update: if isEmployee() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'remarks']);
    }

    // Attendance: Employees log in, Managers view
    match /attendance/{recordId} {
      allow read: if isManager() || (isAuthenticated() && resource.data.employeeId == request.auth.uid); // Assuming employeeId stores UID or email
      allow create: if isAuthenticated(); // Employees clock in
      allow update, delete: if isAdmin();
    }

    // Employee Requests (Leave, etc.)
    match /employee_requests/{requestId} {
      allow read: if isManager() || (isAuthenticated() && resource.data.employeeId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isManager(); // Approve/Reject
    }

    // Payslips: Private to employee
    match /payslips/{slipId} {
      allow read: if isManager() || (isAuthenticated() && resource.data.employeeId == request.auth.uid);
      allow write: if isAdmin(); // Only Owner/Admin generates payslips
    }

    // Invoices: Clients view, Managers write
    match /invoices/{invoiceId} {
      allow read: if isManager() || (isAuthenticated() && resource.data.clientId == request.auth.uid);
      allow write: if isManager();
    }

    // Messages: Chat
    match /messages/{msgId} {
      allow read: if isAuthenticated(); // Simplified for chat
      allow create: if isAuthenticated();
    }

    // Careers: Public read, Admin write
    match /careers/{jobId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Announcements
    match /announcements/{announceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
